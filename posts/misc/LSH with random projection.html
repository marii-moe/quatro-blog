<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.0.35">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>blog – lsh-with-random-projection</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">blog</span>
  </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">About</a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com"><i class="bi bi-twitter" role="img">
</i> 
 </a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">



<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.vision.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="problem-setup" class="level6">
<h6 class="anchored" data-anchor-id="problem-setup">Problem setup</h6>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> untar_data(URLs.IMAGEWOOF_320)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> resnet50(pretrained<span class="op">=</span><span class="va">True</span>).cuda()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/molly/miniconda3/envs/fastai/lib/python3.10/site-packages/torchvision/models/_utils.py:208: UserWarning: The parameter 'pretrained' is deprecated since 0.13 and will be removed in 0.15, please use 'weights' instead.
  warnings.warn(
/home/molly/miniconda3/envs/fastai/lib/python3.10/site-packages/torchvision/models/_utils.py:223: UserWarning: Arguments other than a weight enum or `None` for 'weights' are deprecated since 0.13 and will be removed in 0.15. The current behavior is equivalent to passing `weights=ResNet50_Weights.IMAGENET1K_V1`. You can also use `weights=ResNet50_Weights.DEFAULT` to get the most up-to-date weights.
  warnings.warn(msg)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> DataBlock((ImageBlock,CategoryBlock),</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>                splitter<span class="op">=</span>IndexSplitter([<span class="dv">0</span>,<span class="dv">2</span>]),</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>                item_tfms<span class="op">=</span>Resize(<span class="dv">320</span>),</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>                batch_tfms<span class="op">=</span>aug_transforms(),</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>                get_items<span class="op">=</span>get_image_files).dataloaders(path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> model_call(model,x):</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">#same as model.forward</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> model.conv1(x)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> model.bn1(x)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> model.relu(x)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> model.maxpool(x)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> model.layer1(x)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> model.layer2(x)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> model.layer3(x)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> model.layer4(x)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">#x = model.avgpool(x)</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">#x = torch.flatten(x, 1)</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">#x = model.fc(x)</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>model.fc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>Linear(in_features=2048, out_features=1000, bias=True)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">#model_call(model,dls.one_batch()[0])</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Going to use a relatively small number of buckets, could use much more if we wanted to have less total collisions.</p>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>nbits<span class="op">=</span><span class="dv">8</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>buckets<span class="op">=</span><span class="dv">2</span><span class="op">**</span>nbits</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>bits<span class="op">=</span>torch.arange(<span class="dv">0</span>,<span class="dv">8</span>,device<span class="op">=</span><span class="st">'cuda'</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>nbits,buckets,<span class="fl">2.</span><span class="op">**</span>bits</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>(8,
 256,
 tensor([  1.,   2.,   4.,   8.,  16.,  32.,  64., 128.], device='cuda:0'))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>bits</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>tensor([0, 1, 2, 3, 4, 5, 6, 7], device='cuda:0')</code></pre>
</div>
</div>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>torch.<span class="bu">sum</span>(<span class="dv">2</span><span class="op">**</span>bits)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>tensor(255, device='cuda:0')</code></pre>
</div>
</div>
</section>
<section id="how-would-we-calculate-the-maximum-value-that-we-can-represent" class="level6">
<h6 class="anchored" data-anchor-id="how-would-we-calculate-the-maximum-value-that-we-can-represent">How would we calculate the maximum value that we can represent?</h6>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>[<span class="dv">64</span>, <span class="dv">2048</span>, <span class="dv">10</span>, <span class="dv">10</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>[64, 2048, 10, 10]</code></pre>
</div>
</div>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>[<span class="dv">64</span>, <span class="dv">8</span>, <span class="dv">10</span>, <span class="dv">10</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>[64, 8, 10, 10]</code></pre>
</div>
</div>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>(<span class="fl">2.</span><span class="op">**</span>bits).<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>tensor(255., device='cuda:0')</code></pre>
</div>
</div>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">#dividing by nbits gets us close to 1</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>projector<span class="op">=</span>torch.randn(<span class="dv">2048</span>,nbits).cuda()<span class="op">/</span>nbits<span class="op">**</span><span class="fl">0.5</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>torch.linalg.norm(projector,dim<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>tensor([1.0337, 1.0348, 1.0620,  ..., 1.0139, 1.1947, 1.1155], device='cuda:0')</code></pre>
</div>
</div>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>nbits</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>8</code></pre>
</div>
</div>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>[<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>], [<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>],[<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>([0, 1, 0, 0, 0], [0, 0, 1, 0, 0], [1, 0, 0, 0, 0])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>b<span class="op">=</span>dls.one_batch()[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>dls.show_batch()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="LSH%20with%20random%20projection_files/figure-html/cell-19-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>ys<span class="op">=</span>model_call(model,b)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>(ys[:,:,<span class="va">None</span>]<span class="op">*</span>projector[<span class="va">None</span>,...,<span class="va">None</span>,<span class="va">None</span>]).shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<pre><code>torch.Size([64, 2048, 8, 10, 10])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>ys.shape,projector.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<pre><code>(torch.Size([64, 2048, 10, 10]), torch.Size([2048, 8]))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>torch.einsum(<span class="st">'ijkl,jm-&gt;imkl'</span>,ys,projector).shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="31">
<pre><code>torch.Size([64, 8, 10, 10])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>(torch.einsum(<span class="st">'ijkl,jm-&gt;ijmkl'</span>,ys,projector)<span class="op">==</span>(ys[:,:,<span class="va">None</span>]<span class="op">*</span>projector[<span class="va">None</span>,...,<span class="va">None</span>,<span class="va">None</span>])).<span class="bu">any</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="41">
<pre><code>TensorImage(True, device='cuda:0')</code></pre>
</div>
</div>
</section>
<section id="how-would-you-calculate-the-dot-product-for-the-second-dim-and-first-dim-204810102048881010" class="level5">
<h5 class="anchored" data-anchor-id="how-would-you-calculate-the-dot-product-for-the-second-dim-and-first-dim-204810102048881010">How would you calculate the dot product for the second dim and first dim? (2048,10,10)@(2048,8)=(8,10,10)</h5>
<section id="using-einstein-notation" class="level6">
<h6 class="anchored" data-anchor-id="using-einstein-notation">Using Einstein notation?</h6>
<div class="cell" data-tags="[&quot;hide-cell&quot;]" data-execution_count="32">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>projection<span class="op">=</span>torch.einsum(<span class="st">'bcxy,cz-&gt;bzxy'</span>,ys,projector)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>projection</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="42">
<pre><code>TensorImage([[[[-6.2792e+00,  1.3167e-01, -9.4779e-02,  ..., -2.4656e+00,
                -5.0584e+00, -1.3296e+00],
               [ 8.1754e+00,  9.6036e+00, -4.4357e+00,  ..., -4.6396e+00,
                -7.8996e+00, -2.8259e+00],
               [ 4.4467e+00, -2.1758e+00, -6.7790e+00,  ...,  4.6684e+00,
                 1.3650e+01,  1.0253e+01],
               ...,
               [ 6.3236e-01, -3.8342e+00, -1.3020e+01,  ..., -4.5836e+00,
                -3.6719e+00,  4.8875e+00],
               [-9.5392e+00, -4.3794e+00, -4.9069e+00,  ...,  4.2450e+00,
                -7.0259e+00, -6.6205e+00],
               [-2.8886e+00, -2.2777e+00, -3.5640e+00,  ..., -1.4655e+00,
                -5.7932e+00, -2.0072e+00]],

              [[ 9.2835e+00,  7.7462e+00,  6.1908e+00,  ...,  2.9067e+00,
                 8.0073e+00,  1.1350e+01],
               [ 1.1556e+01,  1.3565e+01,  9.3358e+00,  ...,  3.8952e+00,
                 8.9265e+00,  1.1539e+01],
               [ 9.3274e+00,  7.3811e+00,  1.1513e+01,  ...,  1.6263e+01,
                 2.4063e+01,  1.9001e+01],
               ...,
               [ 6.8415e+00,  5.9298e+00,  7.7832e+00,  ...,  2.8651e+01,
                 4.1376e+00, -4.5388e+00],
               [ 5.3508e+00,  1.1588e+01,  1.2607e+01,  ...,  1.5089e+01,
                 7.7975e+00,  5.8521e+00],
               [ 9.5215e+00,  6.9118e+00,  1.0100e+01,  ...,  8.9737e+00,
                 6.7271e+00,  8.5211e+00]],

              [[-3.1688e+00, -6.4222e+00, -2.8567e+00,  ..., -3.6577e+00,
                -5.9065e+00, -2.9208e+00],
               [-6.0068e+00, -9.4032e+00, -2.8770e+00,  ..., -6.6112e-01,
                -5.0611e+00, -8.4874e+00],
               [-4.4515e+00, -1.0154e+01, -1.2417e+00,  ..., -1.5574e-01,
                -1.1492e+00,  7.6063e+00],
               ...,
               [ 1.5988e+01,  1.3046e+01,  6.4920e+00,  ..., -4.4126e+00,
                 1.4175e+00,  1.2447e+01],
               [ 1.9409e+01,  1.7188e+01,  6.8644e+00,  ..., -3.7321e+00,
                -2.8769e+00,  1.6388e+00],
               [ 1.6584e+01,  1.4844e+01,  9.3730e+00,  ..., -8.5079e-01,
                -6.0974e+00, -3.7285e+00]],

              ...,

              [[-7.1310e+00,  6.5308e-01,  2.6390e+00,  ..., -4.4481e+00,
                -7.0668e+00, -9.1038e+00],
               [ 2.2496e+00,  5.2074e+00,  1.0821e+01,  ..., -3.1807e+00,
                 8.5318e-01, -1.1862e+00],
               [-5.3933e+00,  3.0677e+00,  6.6602e+00,  ..., -4.9860e+00,
                 1.2720e+00,  1.7180e+01],
               ...,
               [-3.8841e+00, -1.0031e+00,  1.4554e+01,  ...,  1.7657e+01,
                 8.1946e+00,  8.0810e+00],
               [-7.9001e+00, -9.9230e+00,  1.9062e+00,  ...,  2.0380e+00,
                -1.1232e+00,  2.4761e+00],
               [-1.1327e+01, -1.5734e+01, -1.2547e+01,  ..., -1.1905e+00,
                 3.4819e+00,  1.7690e+00]],

              [[-5.7783e+00,  1.5963e-01,  3.8980e+00,  ...,  1.9761e+00,
                 1.8847e+00,  2.4780e-01],
               [-1.7248e+00, -3.0383e+00, -6.9456e+00,  ...,  8.2464e+00,
                -2.3109e+00, -2.6400e+00],
               [ 3.1076e-01,  1.4344e+00, -1.1225e+01,  ...,  5.7751e+00,
                 1.9494e+00,  3.9672e+00],
               ...,
               [-1.1729e+01, -1.0031e+01, -2.1186e+01,  ..., -7.7848e+00,
                -1.1644e+01, -1.2071e+01],
               [-1.5569e+01, -2.1363e+01, -2.6422e+01,  ..., -1.6087e+01,
                -1.9381e+01, -2.5736e+01],
               [-2.8877e+01, -2.3298e+01, -1.9927e+01,  ..., -1.1429e+01,
                -1.3280e+01, -2.2741e+01]],

              [[-9.2639e+00, -3.3929e+00,  9.7048e+00,  ..., -3.8852e+00,
                 8.4170e-01,  1.7012e+00],
               [-2.6492e+00,  3.2599e+00,  3.2146e+01,  ...,  2.9210e+00,
                 2.3555e-01,  3.9248e-01],
               [ 1.1340e+01,  1.2774e+01,  2.0421e+01,  ..., -7.9307e+00,
                -1.6897e+01, -4.7462e+00],
               ...,
               [ 9.6164e+00,  1.3184e+01,  1.3542e+01,  ...,  7.6629e+00,
                 1.3888e+01,  1.5293e+01],
               [ 1.0481e+01,  1.4385e+01,  1.1060e+01,  ...,  4.2098e+00,
                 1.1673e+01,  1.5041e+01],
               [ 4.5687e+00,  1.4530e+01,  1.3015e+01,  ...,  9.6600e+00,
                 1.2996e+01,  1.3536e+01]]],


             [[[ 9.5124e+00,  7.0540e+00,  1.0731e+01,  ..., -1.1898e-01,
                -4.8526e+00, -1.6273e+01],
               [ 1.6990e-01, -1.3911e-01,  6.2190e+00,  ..., -6.3489e-01,
                -1.0237e+01, -8.5378e+00],
               [-3.7613e+00, -4.9234e+00, -2.4806e+00,  ..., -2.5140e+00,
                -7.3274e+00, -7.1875e+00],
               ...,
               [-6.5095e+00,  1.7462e+00, -1.9302e-01,  ..., -9.5685e+00,
                -7.6806e+00, -8.3060e-01],
               [-9.2985e-01, -6.4332e+00,  6.1271e+00,  ..., -1.7758e+01,
                -1.5903e+01, -1.8803e+01],
               [ 9.8972e+00,  1.4579e+01,  8.9024e+00,  ..., -2.1343e+01,
                -3.3487e+01, -2.7978e+01]],

              [[ 9.7840e+00,  1.3461e+01,  2.7833e+01,  ...,  5.9922e+00,
                 1.1757e+01,  2.2186e+01],
               [ 6.5224e+00,  6.7404e+00,  1.3893e+01,  ...,  9.1900e+00,
                 1.8095e+01,  1.9578e+01],
               [ 8.7155e-01,  1.9546e+00,  8.3535e+00,  ...,  1.5843e+01,
                 1.7649e+01,  1.1515e+01],
               ...,
               [-1.0384e+01, -1.4986e+01,  5.2173e+00,  ...,  3.0871e+01,
                 4.3548e+01,  4.0713e+01],
               [ 1.8919e+01,  1.2526e+01,  2.4128e+00,  ...,  2.9831e+01,
                 4.2634e+01,  3.9587e+01],
               [ 3.8178e+01,  3.2932e+01,  4.6763e+00,  ...,  3.2836e+01,
                 3.7258e+01,  4.4807e+01]],

              [[-6.7811e+00, -1.3298e+01, -2.0355e+00,  ..., -4.4833e+00,
                -6.0731e+00, -5.2660e+00],
               [-4.5190e+00, -4.7397e+00, -4.3055e+00,  ..., -8.3795e+00,
                -8.6657e+00, -3.1813e+00],
               [-4.0083e+00, -5.4050e+00, -8.3738e+00,  ..., -8.1771e+00,
                -5.7712e+00,  3.3252e+00],
               ...,
               [-2.0961e+01, -1.7522e+01, -1.9436e+01,  ..., -3.9490e+00,
                 3.5565e+00,  4.4478e+00],
               [-2.4070e+01, -2.2667e+01, -7.1590e+00,  ..., -3.1348e+00,
                 5.0762e+00,  1.2960e+01],
               [-7.6899e+00, -8.6212e+00,  6.7536e-01,  ..., -2.6530e-01,
                 1.1745e+01,  1.5273e+01]],

              ...,

              [[ 9.2374e-01,  3.2793e+00, -6.5183e+00,  ...,  4.7281e-01,
                -2.2870e+00,  1.3027e+00],
               [ 4.0763e+00,  3.0901e+00,  4.1876e+00,  ...,  2.0954e+00,
                -9.8625e-01, -3.1275e+00],
               [ 9.6910e-01,  2.8828e-01,  7.4595e-01,  ...,  1.0479e+01,
                 8.2900e+00,  4.0798e+00],
               ...,
               [ 1.2553e+01,  1.4372e+01,  1.3448e+01,  ...,  1.2941e+01,
                 7.6967e+00,  1.1426e+01],
               [ 1.1466e+01,  1.4855e+01,  2.0851e+01,  ...,  3.2110e+01,
                 4.5123e+01,  4.3206e+01],
               [ 1.0600e+01,  7.3636e+00,  1.0523e+01,  ...,  1.6592e+01,
                 2.7320e+01,  5.5086e+01]],

              [[ 2.4515e+00,  1.0092e+01,  1.2336e+01,  ...,  6.2933e+00,
                 4.9184e+00,  9.3574e+00],
               [ 1.2444e+00,  3.0530e+00,  7.1421e+00,  ...,  5.0260e+00,
                 6.4202e+00, -1.7965e+00],
               [-2.0972e+00,  3.1371e-01,  8.9068e-01,  ...,  2.6291e+00,
                 3.4665e+00, -1.9193e+00],
               ...,
               [ 1.5958e+00, -6.7022e+00, -5.6058e+00,  ...,  6.6774e+00,
                 4.8079e+00,  3.4565e+00],
               [-4.5736e-02, -1.8359e+01, -7.8809e+00,  ...,  6.7820e+00,
                 3.7120e+00,  4.0987e+00],
               [ 1.4360e+00, -5.5607e+00,  6.2634e-01,  ..., -1.5635e+00,
                -1.0811e+01, -2.0711e+00]],

              [[ 2.8068e+00,  3.3115e+00,  7.0982e+00,  ...,  2.5611e+00,
                -1.5446e+00, -7.0554e+00],
               [ 3.2848e+00, -2.6821e+00,  4.3762e+00,  ...,  1.6894e+00,
                -1.6904e+00, -6.2212e+00],
               [-4.2415e-01, -3.8746e+00, -4.9796e-01,  ..., -3.5530e-01,
                 2.7174e+00,  1.3833e+01],
               ...,
               [ 6.1781e+00,  3.1638e+00,  7.9841e+00,  ..., -9.4526e+00,
                -3.6841e+00, -1.4651e+01],
               [-6.8839e+00, -3.6912e+00, -3.6544e+00,  ..., -1.6174e+01,
                -2.0845e+01, -2.3711e+01],
               [-3.4264e+00, -5.4144e+00, -1.1610e-01,  ..., -1.2922e+01,
                -1.8294e+01, -2.1884e+01]]],


             [[[ 1.6726e+01,  1.7428e+01,  4.2822e+00,  ...,  1.3308e+01,
                 7.7680e+00,  1.4643e-01],
               [ 1.0972e+01,  1.4134e+01,  4.4387e+00,  ...,  1.5983e+01,
                 7.5606e+00,  2.1118e+00],
               [ 8.8190e+00,  7.4110e+00,  1.1246e+01,  ...,  1.3696e+01,
                 3.8566e+00,  6.2899e+00],
               ...,
               [ 1.2071e+01,  1.0601e+01,  1.6731e+00,  ..., -1.3564e+01,
                -1.3250e+01,  3.3810e-01],
               [ 1.8464e+00,  7.9721e+00,  3.5149e+00,  ..., -1.6235e+01,
                -1.0623e+01,  8.7157e+00],
               [ 8.7276e+00, -9.2056e-01,  7.5868e-01,  ..., -1.1893e+01,
                 2.7289e+00,  2.7667e+01]],

              [[ 6.6531e+00,  1.0010e+01,  2.2753e+01,  ...,  1.4925e+01,
                 1.3476e+01,  1.6543e+01],
               [ 4.5088e+00,  1.9536e+01,  3.0127e+01,  ...,  1.1684e+01,
                 9.8105e+00,  3.2875e+00],
               [ 4.2340e+00,  5.5834e+00,  1.8127e+01,  ..., -3.0256e+00,
                 2.6275e+00, -7.1714e-01],
               ...,
               [ 1.6779e+01,  2.9478e+00,  1.5335e+01,  ...,  3.1999e+01,
                 1.1919e+01,  8.4015e+00],
               [ 1.5926e+01,  2.0441e+00,  7.7098e+00,  ...,  1.2695e+01,
                 1.0315e+01,  5.9256e+00],
               [ 4.5396e+00, -3.9510e+00,  3.0082e+00,  ...,  4.2423e+00,
                 1.4620e+00, -8.1835e-01]],

              [[-1.7676e+01, -1.7258e+01, -1.1684e+01,  ..., -1.0038e+01,
                -7.8505e-02,  5.6030e-01],
               [-1.2038e+01, -1.0079e+01,  3.9319e-01,  ..., -1.3313e+00,
                -2.6005e+00,  6.5192e+00],
               [-5.7970e+00, -1.0169e+01, -1.4580e+01,  ...,  3.7920e+00,
                 2.1885e+00, -2.9092e+00],
               ...,
               [-9.1141e+00, -1.7944e+01, -2.5657e+00,  ..., -2.0504e+01,
                -8.4545e+00,  3.7092e+00],
               [-4.9958e+00, -9.3027e+00, -7.6127e+00,  ..., -1.3733e+01,
                -7.3914e+00,  1.0248e+01],
               [-2.4956e+00, -4.2638e+00, -3.6001e+00,  ..., -5.5006e-01,
                 2.5708e+00,  5.7056e+00]],

              ...,

              [[ 4.2114e-01, -7.9980e+00, -8.6686e+00,  ..., -4.2628e+00,
                 8.8063e+00, -9.2941e-02],
               [-8.4785e+00, -1.7714e+01, -5.5977e-01,  ...,  9.8289e-01,
                 1.2428e+01,  9.1162e+00],
               [-9.5216e+00, -2.6300e+01, -1.7297e+01,  ...,  4.7637e+00,
                 6.2845e+00,  4.5398e+00],
               ...,
               [ 1.2768e+00, -6.3151e+00, -1.0408e+00,  ...,  7.4808e-01,
                -1.0534e+00,  4.4392e+00],
               [ 3.0409e+00, -1.3620e+00,  3.0350e+00,  ..., -9.6885e+00,
                -2.5018e+00, -3.8327e+00],
               [-1.6695e+01, -1.1960e+01, -6.9895e+00,  ..., -8.2594e+00,
                -1.4068e+01, -2.0667e+01]],

              [[ 5.1652e+00,  1.0395e+01,  7.4535e+00,  ...,  8.6804e+00,
                 4.5424e+00,  1.4589e+01],
               [ 4.9551e+00,  1.8278e+01,  2.8135e+01,  ...,  2.0059e+01,
                 1.2688e+01,  1.1655e+01],
               [ 8.6485e+00,  2.4904e+01,  4.3337e+01,  ...,  1.4686e+01,
                 1.6079e+01,  2.0526e+01],
               ...,
               [ 3.6101e+00, -3.5364e+00,  7.2125e+00,  ..., -8.2165e-01,
                -7.4522e+00,  6.1776e+00],
               [-3.6109e+00, -6.7193e+00,  1.2664e+01,  ..., -5.5758e+00,
                -7.2992e+00,  3.7080e+00],
               [-9.0229e-01, -2.1786e+00,  7.6342e+00,  ..., -7.0221e+00,
                -9.6212e+00,  5.1720e+00]],

              [[-1.1960e+01, -1.1723e+01, -2.1839e+01,  ..., -7.9723e+00,
                 9.2299e+00,  5.2175e+00],
               [-1.4355e+01, -2.1408e+01, -3.0463e+01,  ...,  3.5703e+00,
                 4.7135e+00,  7.2011e+00],
               [-1.3361e+01, -2.6255e+01, -3.8794e+01,  ...,  2.9431e+00,
                -4.4089e+00,  1.5832e-01],
               ...,
               [-4.0332e+00, -1.0877e+01, -1.0693e+01,  ..., -7.4630e+00,
                -1.3602e-01,  1.2742e+00],
               [-3.7040e+00, -2.8553e+00, -8.7539e+00,  ...,  6.7736e-01,
                 2.3848e+00, -1.8044e-01],
               [-8.3037e+00, -1.0215e+01, -8.9308e+00,  ...,  1.6606e+01,
                 1.4776e+00, -7.1054e+00]]],


             ...,


             [[[ 3.0742e+01,  2.0617e+01,  3.4883e+00,  ..., -9.0017e+00,
                -1.6916e+00,  3.9473e-01],
               [ 3.5029e+01,  2.8505e+01,  1.3211e+01,  ..., -5.5471e+00,
                -6.9257e+00, -2.2475e+00],
               [ 1.4213e+01,  2.3229e+01,  1.6051e+01,  ..., -1.8002e-01,
                -3.7035e-01,  6.3750e+00],
               ...,
               [ 8.4374e-01,  4.3312e+00, -3.1439e-01,  ..., -4.4065e+00,
                -1.1842e+00,  3.8927e+00],
               [-1.3196e+00, -4.4678e-01, -2.1221e+00,  ..., -2.8409e+00,
                -4.0868e+00,  2.5064e+00],
               [-3.6652e-01, -9.4469e-01, -9.2601e+00,  ..., -3.7837e+00,
                -1.7367e+00,  8.7911e+00]],

              [[ 2.1170e+01,  1.9605e+01,  8.4797e+00,  ...,  1.7911e+01,
                 8.9692e+00,  6.8814e+00],
               [ 1.5301e+01,  1.3120e+01,  1.9084e+00,  ...,  1.5672e+01,
                 1.0492e+01,  9.9011e+00],
               [ 4.6515e+00, -1.0032e+00,  1.7698e+00,  ...,  9.0264e+00,
                 7.3372e+00,  2.9377e+00],
               ...,
               [ 9.4733e+00,  1.7173e+01,  1.2714e+01,  ...,  2.1929e+01,
                 1.6661e+01,  1.2190e+01],
               [ 4.9162e+00,  1.5067e+01,  1.7427e+01,  ...,  1.6764e+01,
                 1.1263e+01,  1.2861e+01],
               [ 3.4370e+00,  1.0124e+01,  1.2676e+01,  ...,  2.0788e+01,
                 1.6364e+01,  2.2770e+01]],

              [[ 1.7073e+01,  1.2411e+01,  3.9940e+00,  ..., -2.5094e-01,
                 1.0745e+00,  2.0860e+00],
               [ 9.7372e+00,  2.9299e+00, -5.5394e+00,  ...,  1.9889e+00,
                 3.3939e+00, -1.5617e+00],
               [-2.5642e-01, -1.1352e+00, -8.8535e+00,  ..., -4.5452e+00,
                -1.9397e+00, -7.2823e+00],
               ...,
               [-2.0316e+00, -2.9228e+00, -4.4708e+00,  ..., -3.9330e+00,
                -1.1184e+01, -9.1596e+00],
               [ 4.0511e-01, -5.1108e-01, -5.8130e+00,  ..., -3.4118e+00,
                -4.2866e+00, -2.3001e+00],
               [-3.2900e+00, -7.9968e+00, -4.4886e+00,  ..., -4.5846e+00,
                -5.1580e+00, -5.1870e+00]],

              ...,

              [[-1.0441e+01,  3.6222e-01,  5.7083e+00,  ..., -8.7860e-01,
                -5.9626e+00, -2.4280e+00],
               [-3.2910e-01,  3.1008e+00,  1.1946e+01,  ...,  2.7110e+00,
                -5.6768e+00, -6.1909e+00],
               [-5.4021e+00,  1.0762e+01,  2.7438e+01,  ...,  5.8677e+00,
                -1.0364e-01, -2.4942e+00],
               ...,
               [ 7.0567e-01, -3.1743e+00, -1.8512e+00,  ...,  4.5055e+00,
                 1.3033e+00, -8.2645e+00],
               [-3.0940e+00,  2.9549e+00,  1.0386e+01,  ..., -4.2258e+00,
                -8.3496e+00, -6.9864e+00],
               [-5.8167e+00,  5.5948e+00,  2.3419e+01,  ..., -6.6175e+00,
                -1.2134e+01, -7.1784e+00]],

              [[-1.5039e+01, -5.6994e+00,  6.0646e+00,  ...,  4.8761e+00,
                -1.6647e+00, -3.3653e+00],
               [-1.2232e+01,  3.2679e-01,  2.1025e+00,  ...,  4.5207e+00,
                -6.3115e-01,  4.4318e-01],
               [-1.6360e+01, -4.2183e-01, -2.9451e+00,  ..., -3.2819e+00,
                -7.8153e+00, -3.9869e+00],
               ...,
               [-9.9416e+00,  1.5021e+01,  1.2003e+01,  ..., -5.2349e+00,
                 2.6565e+00, -2.1975e+00],
               [-1.3382e+01,  2.7150e+00,  7.4891e+00,  ..., -5.7495e+00,
                 8.4802e+00,  6.6035e+00],
               [-1.3810e+01,  7.6381e+00,  5.1958e+00,  ..., -1.8646e+00,
                 3.0005e+00,  9.3771e-01]],

              [[ 1.3810e+01,  1.7808e+01,  8.6061e+00,  ...,  1.1546e+01,
                 8.8377e+00,  8.1417e+00],
               [ 1.1785e+01,  1.7363e+01, -4.3577e+00,  ...,  3.6378e+00,
                 1.6090e+01,  1.5553e+01],
               [ 1.0965e+01,  2.3075e+00, -2.3853e+00,  ..., -8.7184e+00,
                 1.7130e+01,  1.8968e+01],
               ...,
               [ 2.2361e+00,  2.7280e+00,  6.5013e+00,  ...,  5.6273e+00,
                 8.9686e+00,  9.0201e+00],
               [ 5.5273e+00,  3.4220e+00, -9.4277e+00,  ...,  8.6742e-01,
                 7.3521e+00,  1.1186e+01],
               [ 4.3832e+00, -6.7473e-01, -1.1554e+01,  ...,  6.7014e+00,
                 8.0967e+00,  7.0652e+00]]],


             [[[-2.6913e+01, -2.9568e+01, -8.9120e+00,  ..., -3.6777e+00,
                -9.5993e+00, -1.3907e+01],
               [-3.3114e+01, -4.0868e+01, -3.1856e+01,  ..., -2.1573e+00,
                -7.5814e+00, -1.1474e+01],
               [-2.7869e+01, -3.9983e+01, -2.6464e+01,  ...,  6.0545e+00,
                -6.4322e+00, -6.3355e+00],
               ...,
               [-1.6259e+01, -1.7102e+01, -9.8119e+00,  ..., -2.6094e+00,
                -9.1046e+00, -4.5698e+00],
               [-4.2792e+00, -1.4512e+01, -7.5014e+00,  ..., -3.2948e-01,
                -8.0459e+00, -5.2389e+00],
               [-2.2665e-03, -1.0965e+01, -7.7879e+00,  ..., -9.6266e+00,
                -1.0545e+01, -7.5697e-01]],

              [[ 1.5671e+00,  1.2056e+01,  1.2069e+01,  ...,  2.4591e+01,
                 3.2034e+01,  3.6939e+01],
               [-3.8125e+00,  3.2298e+00,  1.2571e+01,  ...,  2.2087e+01,
                 2.9005e+01,  1.8920e+01],
               [ 7.9042e-01,  2.6120e+01,  3.5221e+01,  ...,  3.8826e+00,
                 1.6314e+01,  2.7712e+01],
               ...,
               [-2.7849e+00, -1.0391e+01, -5.8262e+00,  ...,  6.0313e+00,
                 6.1854e+00,  7.3942e+00],
               [ 8.9106e+00,  6.6072e+00,  3.7478e+00,  ...,  4.4233e+00,
                -1.8716e-01, -3.8388e-01],
               [ 2.1626e+01,  1.3852e+01,  1.0201e+01,  ...,  3.2672e+00,
                -1.1369e+00,  3.3530e+00]],

              [[ 8.4911e+00,  8.4341e+00,  4.6288e+00,  ...,  1.3576e+01,
                -7.2182e+00, -1.2758e+01],
               [ 2.1120e+01,  1.2484e+01,  8.6090e-02,  ..., -1.1351e+00,
                -1.4208e+01, -1.1975e+01],
               [-3.1700e+00, -4.0954e+00, -1.6492e+00,  ..., -1.0604e+01,
                -9.4700e+00,  6.6750e-01],
               ...,
               [ 2.9052e+00,  6.3958e+00,  1.3706e-01,  ...,  5.7390e+00,
                 3.1581e+00, -6.0765e-01],
               [-3.8417e+00, -4.2816e+00, -5.9917e-01,  ...,  6.7638e+00,
                 5.0139e+00,  5.6882e+00],
               [-1.8144e+01, -1.2465e+01, -4.2393e+00,  ...,  4.2922e+00,
                 6.0590e+00,  9.7644e+00]],

              ...,

              [[-7.3576e+00,  1.0356e+01,  3.1724e-01,  ...,  1.8843e+01,
                 1.8283e+01,  1.0810e+01],
               [-7.3645e+00,  5.2899e+00,  1.3292e+00,  ...,  1.3994e+01,
                 8.5479e+00, -4.9072e+00],
               [-9.9293e+00,  2.7770e+00, -8.8405e+00,  ...,  3.1427e+00,
                 1.9661e+00,  8.4572e+00],
               ...,
               [-8.4440e+00, -5.7747e+00, -7.7229e+00,  ...,  8.1245e+00,
                -3.8143e+00, -9.9999e+00],
               [ 6.4093e-01,  5.9969e+00, -6.3158e+00,  ...,  1.4593e+00,
                -5.8362e+00, -1.3630e+01],
               [ 4.7849e+00,  4.6974e+00,  3.1298e+00,  ..., -4.9041e+00,
                -1.0216e+01, -1.2580e+01]],

              [[-5.8014e+00, -1.0372e+01,  1.0254e+01,  ..., -4.6294e-01,
                 1.8217e+01,  1.0038e+01],
               [ 5.7797e+00,  9.2750e+00,  2.1096e+01,  ...,  8.8768e+00,
                 2.2236e+01,  2.0851e+01],
               [ 1.4236e+01,  3.3656e+01,  3.3081e+01,  ...,  2.2807e+01,
                 3.4478e+01,  1.7018e+01],
               ...,
               [ 1.9373e+01,  1.7202e+01,  7.0146e-01,  ...,  9.4769e+00,
                 5.3170e+00,  7.5832e+00],
               [ 2.3346e+01,  2.6482e+01,  1.0779e+01,  ...,  1.0170e+00,
                 9.9077e+00,  6.9110e+00],
               [ 1.7564e+01,  2.1025e+01,  1.2639e+01,  ...,  4.6908e+00,
                 5.8073e+00,  3.1757e+00]],

              [[-5.2906e+00, -2.7127e+00,  1.5336e+01,  ..., -3.3235e+00,
                 3.0431e+00,  4.4982e+00],
               [-3.8740e+00, -2.7825e-01,  1.8444e+01,  ..., -6.8304e+00,
                -9.7458e+00, -2.2539e+00],
               [-2.3341e+00,  1.1108e+00,  9.1996e+00,  ...,  1.4541e+00,
                 4.0044e+00,  5.3693e+00],
               ...,
               [-5.5670e+00, -3.2424e+00, -1.0724e+01,  ..., -2.3431e+00,
                 3.1732e+00,  2.2250e+00],
               [ 4.7924e+00,  2.9135e+00,  1.0695e+00,  ..., -3.1337e+00,
                 3.6863e+00,  9.4232e+00],
               [ 1.3064e+01,  1.4679e+00,  4.2512e+00,  ...,  2.0431e+00,
                 5.5197e+00,  9.0792e+00]]],


             [[[-4.1837e+00,  4.4228e+00,  7.5466e+00,  ...,  9.0294e+00,
                 1.8985e+00,  1.3472e+00],
               [ 3.4190e+00,  7.7751e+00,  1.4765e+01,  ...,  1.0512e+01,
                 1.2134e+01,  1.3603e+01],
               [ 1.1120e+01,  1.9633e+01,  1.5074e+01,  ...,  7.3059e+00,
                 5.4364e+00,  1.3671e+01],
               ...,
               [ 7.7573e+00,  6.5959e+00,  2.4744e+00,  ...,  1.3797e+01,
                 2.7515e+00,  2.0304e+00],
               [ 5.0850e+00,  9.8228e+00,  7.2073e+00,  ...,  3.0873e-01,
                -2.5682e+01, -1.1913e+01],
               [-1.9177e+00,  1.0239e+00,  2.1603e+00,  ...,  7.6998e-02,
                -1.0977e+01, -1.0928e+01]],

              [[ 9.6061e+00,  1.5370e+00,  2.8735e+00,  ...,  5.0786e+00,
                 1.1083e+01,  9.2034e+00],
               [ 3.0860e+00,  7.1579e+00,  6.0781e+00,  ...,  7.9867e+00,
                 3.1649e+00,  5.9685e+00],
               [ 2.0483e+00,  1.4068e+01,  9.0135e+00,  ...,  4.9285e+00,
                 6.5073e+00, -3.5669e+00],
               ...,
               [-1.0659e+00,  4.2513e+00,  3.0158e+00,  ...,  2.1836e+00,
                -7.4681e+00, -1.0047e+01],
               [-6.4479e+00, -1.6330e+00,  7.5435e+00,  ...,  1.3588e+01,
                 1.1536e+00, -1.1312e+01],
               [-4.2848e+00,  4.4101e+00,  9.2249e+00,  ...,  1.7328e+01,
                 1.4831e+01, -7.3449e-01]],

              [[-1.3682e+00, -5.1753e+00, -4.2238e+00,  ..., -1.3184e+01,
                -1.0707e+01, -9.5371e+00],
               [-1.6860e+00, -3.3730e+00,  3.3757e+00,  ..., -9.6586e+00,
                -4.3802e+00, -4.1719e-02],
               [-4.7046e-01, -4.2123e-01, -3.8035e+00,  ..., -9.6757e+00,
                -1.5742e+01, -1.8032e+00],
               ...,
               [-4.2253e+00, -3.7856e+00, -4.7338e+00,  ...,  6.0688e+00,
                -2.2821e+00,  6.7935e+00],
               [-8.7673e+00, -2.8977e-01, -1.8588e+00,  ...,  7.1490e+00,
                -4.2642e+00, -4.3403e-01],
               [-1.3027e+01, -9.8119e+00, -4.1386e+00,  ..., -3.9124e+00,
                -1.8475e+01, -5.6218e+00]],

              ...,

              [[-1.3048e+01, -6.4990e+00,  3.7771e+00,  ..., -3.5662e-01,
                -2.1649e+01, -1.9933e+01],
               [-1.3308e+01,  1.0137e+00,  4.0163e+00,  ...,  1.5178e+01,
                -1.8908e+01, -2.6649e+01],
               [-6.0838e+00,  4.4509e+00,  9.2461e+00,  ...,  1.2517e+01,
                -6.9830e+00, -1.0261e+01],
               ...,
               [ 3.8149e+00,  1.0815e+01,  3.1839e+00,  ...,  9.5991e+00,
                 3.8434e+00,  2.1540e+00],
               [-2.1296e+00, -1.8112e+00, -2.8965e+00,  ..., -6.4432e+00,
                -6.9710e+00, -5.0703e-01],
               [ 7.2261e+00, -2.4904e+00, -6.8260e+00,  ..., -8.1620e+00,
                -4.7305e+00, -1.3990e+00]],

              [[ 6.4019e+00,  1.4235e+01,  1.1706e+01,  ...,  8.1696e+00,
                 1.3590e+01,  1.1112e+01],
               [ 9.0817e+00,  1.8450e+01,  1.8520e+00,  ...,  2.9886e+00,
                 1.0353e+01,  1.9502e+01],
               [ 1.2688e+01,  1.2391e+01,  7.0384e+00,  ..., -4.8993e+00,
                 4.6831e+00,  1.3654e+01],
               ...,
               [ 6.8772e+00,  4.8467e+00,  3.6678e+00,  ..., -3.3305e+00,
                 2.7749e+01,  3.7785e+01],
               [ 1.4010e+01,  1.1408e+01,  5.3943e+00,  ..., -2.1537e+01,
                 2.1972e+00,  3.4320e+01],
               [ 1.4877e+01,  1.7063e+01,  6.9275e+00,  ..., -1.4477e+01,
                -3.4017e+00,  3.0101e+01]],

              [[-3.0831e+00,  3.0010e+00,  6.9832e+00,  ..., -1.8217e+00,
                -7.1681e+00, -3.4423e+00],
               [ 8.3796e+00,  3.6513e+00, -2.5611e+00,  ..., -6.8060e+00,
                -1.4611e+01, -8.5084e+00],
               [-6.5332e-01, -1.1911e+01, -1.2325e+01,  ..., -4.0894e+00,
                -1.0735e+01,  1.7551e+00],
               ...,
               [ 3.4406e+00,  1.4224e+00, -3.6680e+00,  ..., -1.0623e+01,
                -2.8591e+01, -1.4722e+01],
               [ 3.2616e+00,  2.6747e+00, -1.9402e+00,  ..., -6.7384e+00,
                -1.2895e+01, -1.5971e+01],
               [ 1.2498e+01,  2.2431e+00, -3.8494e+00,  ..., -9.0071e+00,
                -2.1719e+01, -1.8405e+01]]]], device='cuda:0',
            grad_fn=&lt;AliasBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span><span class="op">**</span>bits, <span class="dv">0</span><span class="op">-</span><span class="dv">255</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="47">
<pre><code>(tensor([  1,   2,   4,   8,  16,  32,  64, 128], device='cuda:0'), -255)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>(<span class="dv">1</span><span class="op">*</span>(projection<span class="op">&gt;</span><span class="dv">0</span>)).shape,(<span class="dv">2</span><span class="op">**</span>bits[...,<span class="va">None</span>,<span class="va">None</span>]).shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="50">
<pre><code>(torch.Size([64, 8, 10, 10]), torch.Size([8, 1, 1]))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="54">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="54">
<pre><code>torch.Size([64, 10, 10])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>projection.shape,(<span class="fl">2.</span><span class="op">**</span>bits).shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="33">
<pre><code>(torch.Size([64, 8, 10, 10]), torch.Size([8]))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>(<span class="dv">1</span><span class="op">*</span>(projection<span class="op">&gt;</span><span class="dv">0</span>)).shape,(<span class="dv">2</span><span class="op">**</span>bits).shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="53">
<pre><code>(torch.Size([64, 8, 10, 10]), torch.Size([8]))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="67">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span><span class="op">**</span>bits,(<span class="dv">1</span><span class="op">*</span>(projection<span class="op">&gt;</span><span class="dv">0</span>)).shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="67">
<pre><code>(tensor([  1,   2,   4,   8,  16,  32,  64, 128], device='cuda:0'),
 torch.Size([64, 8, 10, 10]))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="68">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>((<span class="dv">1</span><span class="op">*</span>(projection<span class="op">&gt;</span><span class="dv">0</span>)[:,:,<span class="dv">0</span>,<span class="dv">0</span>])<span class="op">*</span>(<span class="dv">2</span><span class="op">**</span>bits))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="68">
<pre><code>TensorImage([[  0,   2,   0,   8,   0,   0,   0,   0],
             [  1,   2,   0,   0,   0,  32,  64, 128],
             [  1,   2,   0,   0,   0,  32,  64,   0],
             [  0,   2,   0,   0,   0,   0,   0,   0],
             [  0,   2,   4,   8,  16,   0,   0, 128],
             [  0,   2,   0,   8,   0,   0,   0, 128],
             [  0,   2,   4,   0,  16,   0,  64, 128],
             [  0,   2,   4,   0,   0,  32,  64, 128],
             [  0,   2,   0,   0,   0,  32,   0,   0],
             [  1,   2,   0,   0,   0,   0,  64, 128],
             [  1,   2,   0,   0,   0,  32,   0, 128],
             [  0,   2,   0,   0,   0,   0,  64, 128],
             [  1,   2,   0,   0,   0,   0,  64,   0],
             [  0,   2,   0,   0,   0,  32,  64, 128],
             [  1,   2,   0,   0,   0,  32,   0,   0],
             [  0,   2,   4,   8,   0,   0,   0,   0],
             [  1,   2,   0,   0,   0,  32,  64, 128],
             [  0,   2,   4,   8,  16,   0,  64, 128],
             [  0,   2,   4,   0,   0,  32,   0,   0],
             [  0,   2,   0,   8,   0,   0,   0, 128],
             [  1,   2,   4,   0,   0,  32,  64,   0],
             [  0,   2,   0,   0,   0,   0,  64,   0],
             [  1,   2,   4,   0,   0,  32,   0,   0],
             [  0,   2,   0,   0,  16,   0,   0, 128],
             [  1,   2,   0,   0,  16,   0,   0, 128],
             [  0,   2,   4,   0,  16,   0,  64, 128],
             [  0,   2,   4,   8,  16,   0,  64, 128],
             [  0,   2,   4,   8,  16,   0,  64, 128],
             [  0,   2,   0,   0,  16,  32,   0,   0],
             [  1,   2,   0,   0,   0,   0,  64, 128],
             [  1,   2,   0,   0,   0,   0,   0,   0],
             [  0,   2,   4,   8,   0,   0,   0, 128],
             [  1,   2,   0,   0,   0,  32,   0, 128],
             [  1,   2,   0,   0,   0,   0,   0, 128],
             [  0,   2,   4,   8,   0,   0,  64,   0],
             [  0,   2,   4,   8,   0,   0,  64,   0],
             [  0,   2,   0,   8,   0,   0,   0, 128],
             [  1,   2,   0,   8,   0,  32,  64,   0],
             [  0,   0,   4,   8,  16,   0,  64, 128],
             [  0,   0,   4,   8,  16,  32,   0, 128],
             [  1,   0,   0,   0,   0,  32,  64,   0],
             [  0,   2,   4,   8,  16,   0,  64, 128],
             [  0,   2,   0,   0,  16,   0,   0, 128],
             [  1,   2,   4,   8,   0,   0,   0, 128],
             [  1,   2,   0,   0,   0,  32,  64,   0],
             [  0,   2,   0,   8,  16,   0,  64, 128],
             [  0,   2,   0,   0,   0,  32,   0,   0],
             [  0,   2,   4,   0,   0,   0,   0, 128],
             [  1,   0,   0,   0,   0,  32,  64,   0],
             [  1,   2,   0,   0,   0,  32,   0, 128],
             [  0,   2,   4,   0,  16,  32,   0, 128],
             [  1,   2,   0,   0,  16,   0,  64, 128],
             [  0,   0,   0,   0,  16,  32,  64,   0],
             [  1,   2,   4,   0,  16,   0,  64, 128],
             [  0,   2,   0,   0,   0,   0,  64,   0],
             [  0,   2,   0,   8,   0,   0,  64,   0],
             [  0,   2,   0,   0,   0,   0,   0, 128],
             [  0,   2,   4,   8,   0,   0,  64,   0],
             [  1,   2,   0,   8,   0,   0,  64,   0],
             [  1,   2,   0,   0,   0,  32,  64,   0],
             [  0,   2,   4,   8,  16,   0,  64,   0],
             [  1,   2,   4,   8,  16,   0,   0, 128],
             [  0,   2,   4,   0,  16,   0,   0,   0],
             [  0,   2,   0,   8,  16,   0,  64,   0]], device='cuda:0')</code></pre>
</div>
</div>
<div class="cell" data-execution_count="59">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>torch.einsum(<span class="st">'ijkl,j-&gt;ikl'</span>,<span class="fl">1.</span><span class="op">*</span>(projection<span class="op">&gt;</span><span class="dv">0</span>),(<span class="fl">2.</span><span class="op">**</span>bits))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="59">
<pre><code>TensorImage([[[ 10.,  99., 226.,  ...,  66., 194., 194.],
              [ 35., 163., 162.,  ..., 194., 162., 130.],
              [211., 242., 178.,  ...,  67., 115., 119.],
              ...,
              [151., 134., 166.,  ..., 162., 166., 165.],
              [134., 134., 166.,  ..., 163., 146., 182.],
              [150., 150., 150.,  ..., 146., 178., 178.]],

             [[227., 243., 211.,  ..., 226.,  66., 106.],
              [227.,  98., 227.,  ..., 226.,  82.,  18.],
              [ 34.,  98.,  98.,  ..., 114., 242., 166.],
              ...,
              [232., 169., 170.,  ...,  98., 102., 110.],
              [ 42.,  42.,  43.,  ...,  98., 102., 102.],
              [ 99.,  35., 111.,  ...,  42.,  38.,  38.]],

             [[ 99.,  83.,  67.,  ...,  67., 227., 215.],
              [ 67.,  67.,  87.,  ..., 227., 243., 231.],
              [ 67.,  67.,  83.,  ..., 229., 119., 241.],
              ...,
              [ 99.,   3.,  67.,  ...,  34.,   2., 231.],
              [ 35.,   3., 107.,  ..., 130., 130.,  71.],
              [  3.,   8.,  75.,  ..., 130., 135.,  69.]],

             ...,

             [[159., 183., 231.,  ..., 194., 134., 151.],
              [151., 247.,  99.,  ..., 246., 150., 210.],
              [147., 161.,  35.,  ...,  34., 146., 147.],
              ...,
              [179., 195., 194.,  ..., 162., 226., 131.],
              [150., 226.,  98.,  ..., 130., 194., 195.],
              [146.,  98.,  98.,  ..., 130., 194., 195.]],

             [[ 22.,  54., 246.,  ...,  38., 226., 226.],
              [ 68., 102., 246.,  ...,  98.,  98.,  66.],
              [ 82., 226., 210.,  ..., 227., 226., 230.],
              ...,
              [ 68.,  68.,  68.,  ..., 102., 198., 202.],
              [226., 226., 194.,  ..., 102., 196., 204.],
              [226., 226., 226.,  ..., 222., 212., 214.]],

             [[ 90., 195., 227.,  ...,  91.,  83.,  83.],
              [203., 235., 119.,  ..., 115.,  75.,  75.],
              [ 75., 115., 115.,  ...,  51.,  83., 201.],
              ...,
              [249., 243., 115.,  ...,  63., 105., 109.],
              [193., 193.,  91.,  ...,  31.,  90.,  64.],
              [232., 203.,  91.,  ...,  27.,  18.,  64.]]], device='cuda:0')</code></pre>
</div>
</div>
</section>
<section id="how-would-we-calculate-the-bucket-for-each-xy-location" class="level6">
<h6 class="anchored" data-anchor-id="how-would-we-calculate-the-bucket-for-each-xy-location">How would we calculate the bucket for each x,y location?</h6>
<div class="cell" data-execution_count="61">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>hash_loc<span class="op">=</span>torch.einsum(<span class="st">'bchw,c-&gt;bhw'</span>,(projection<span class="op">&gt;</span><span class="dv">0</span>).<span class="bu">float</span>(),<span class="fl">2.</span><span class="op">**</span>bits).<span class="bu">int</span>()</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>hash_loc.shape,hash_loc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="61">
<pre><code>(torch.Size([64, 10, 10]),
 TensorImage([[[ 10,  99, 226,  ...,  66, 194, 194],
               [ 35, 163, 162,  ..., 194, 162, 130],
               [211, 242, 178,  ...,  67, 115, 119],
               ...,
               [151, 134, 166,  ..., 162, 166, 165],
               [134, 134, 166,  ..., 163, 146, 182],
               [150, 150, 150,  ..., 146, 178, 178]],
 
              [[227, 243, 211,  ..., 226,  66, 106],
               [227,  98, 227,  ..., 226,  82,  18],
               [ 34,  98,  98,  ..., 114, 242, 166],
               ...,
               [232, 169, 170,  ...,  98, 102, 110],
               [ 42,  42,  43,  ...,  98, 102, 102],
               [ 99,  35, 111,  ...,  42,  38,  38]],
 
              [[ 99,  83,  67,  ...,  67, 227, 215],
               [ 67,  67,  87,  ..., 227, 243, 231],
               [ 67,  67,  83,  ..., 229, 119, 241],
               ...,
               [ 99,   3,  67,  ...,  34,   2, 231],
               [ 35,   3, 107,  ..., 130, 130,  71],
               [  3,   8,  75,  ..., 130, 135,  69]],
 
              ...,
 
              [[159, 183, 231,  ..., 194, 134, 151],
               [151, 247,  99,  ..., 246, 150, 210],
               [147, 161,  35,  ...,  34, 146, 147],
               ...,
               [179, 195, 194,  ..., 162, 226, 131],
               [150, 226,  98,  ..., 130, 194, 195],
               [146,  98,  98,  ..., 130, 194, 195]],
 
              [[ 22,  54, 246,  ...,  38, 226, 226],
               [ 68, 102, 246,  ...,  98,  98,  66],
               [ 82, 226, 210,  ..., 227, 226, 230],
               ...,
               [ 68,  68,  68,  ..., 102, 198, 202],
               [226, 226, 194,  ..., 102, 196, 204],
               [226, 226, 226,  ..., 222, 212, 214]],
 
              [[ 90, 195, 227,  ...,  91,  83,  83],
               [203, 235, 119,  ..., 115,  75,  75],
               [ 75, 115, 115,  ...,  51,  83, 201],
               ...,
               [249, 243, 115,  ...,  63, 105, 109],
               [193, 193,  91,  ...,  31,  90,  64],
               [232, 203,  91,  ...,  27,  18,  64]]], device='cuda:0',
             dtype=torch.int32))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="69">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>hash_loc.flatten().mode()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="69">
<pre><code>torch.return_types.mode(
values=TensorImage(99, device='cuda:0', dtype=torch.int32),
indices=TensorImage(1, device='cuda:0'))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="75">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>hash_loc<span class="op">==</span><span class="dv">99</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="75">
<pre><code>TensorImage([[[False,  True, False,  ..., False, False, False],
              [False, False, False,  ..., False, False, False],
              [False, False, False,  ..., False, False, False],
              ...,
              [False, False, False,  ..., False, False, False],
              [False, False, False,  ..., False, False, False],
              [False, False, False,  ..., False, False, False]],

             [[False, False, False,  ..., False, False, False],
              [False, False, False,  ..., False, False, False],
              [False, False, False,  ..., False, False, False],
              ...,
              [False, False, False,  ..., False, False, False],
              [False, False, False,  ..., False, False, False],
              [ True, False, False,  ..., False, False, False]],

             [[ True, False, False,  ..., False, False, False],
              [False, False, False,  ..., False, False, False],
              [False, False, False,  ..., False, False, False],
              ...,
              [ True, False, False,  ..., False, False, False],
              [False, False, False,  ..., False, False, False],
              [False, False, False,  ..., False, False, False]],

             ...,

             [[False, False, False,  ..., False, False, False],
              [False, False,  True,  ..., False, False, False],
              [False, False, False,  ..., False, False, False],
              ...,
              [False, False, False,  ..., False, False, False],
              [False, False, False,  ..., False, False, False],
              [False, False, False,  ..., False, False, False]],

             [[False, False, False,  ..., False, False, False],
              [False, False, False,  ..., False, False, False],
              [False, False, False,  ..., False, False, False],
              ...,
              [False, False, False,  ..., False, False, False],
              [False, False, False,  ..., False, False, False],
              [False, False, False,  ..., False, False, False]],

             [[False, False, False,  ..., False, False, False],
              [False, False, False,  ..., False, False, False],
              [False, False, False,  ..., False, False, False],
              ...,
              [False, False, False,  ..., False, False, False],
              [False, False, False,  ..., False, False, False],
              [False, False, False,  ..., False, False, False]]],
            device='cuda:0')</code></pre>
</div>
</div>
</section>
<section id="how-would-we-generate-a-mask-for-the-locations-that-equal-the-mode199" class="level6">
<h6 class="anchored" data-anchor-id="how-would-we-generate-a-mask-for-the-locations-that-equal-the-mode199">How would we generate a mask for the locations that equal the mode(199)?</h6>
<div class="cell" data-scrolled="true" data-execution_count="30">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>(hash_loc<span class="op">==</span><span class="dv">199</span>).shape,(hash_loc<span class="op">==</span><span class="dv">199</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<pre><code>(torch.Size([64, 10, 10]),
 TensorImage([[[False, False, False,  ..., False, False, False],
               [False, False, False,  ..., False, False, False],
               [False, False, False,  ..., False, False, False],
               ...,
               [False, False, False,  ..., False, False, False],
               [False, False, False,  ...,  True,  True,  True],
               [False, False, False,  ...,  True, False, False]],
 
              [[False, False, False,  ..., False, False, False],
               [False, False, False,  ..., False, False, False],
               [False, False, False,  ..., False, False, False],
               ...,
               [False, False, False,  ..., False, False, False],
               [False, False, False,  ..., False, False, False],
               [False, False, False,  ..., False, False, False]],
 
              [[False, False, False,  ...,  True,  True,  True],
               [False, False, False,  ..., False, False, False],
               [False, False, False,  ..., False, False, False],
               ...,
               [False, False, False,  ..., False,  True,  True],
               [False, False, False,  ..., False, False,  True],
               [False, False, False,  ...,  True, False, False]],
 
              ...,
 
              [[False, False, False,  ..., False, False, False],
               [False, False, False,  ...,  True, False, False],
               [ True, False, False,  ..., False, False, False],
               ...,
               [False, False, False,  ..., False, False, False],
               [False, False, False,  ..., False, False, False],
               [False, False, False,  ..., False, False, False]],
 
              [[False, False, False,  ...,  True, False, False],
               [False, False, False,  ...,  True, False, False],
               [False, False, False,  ...,  True, False, False],
               ...,
               [False, False,  True,  ..., False, False, False],
               [False, False,  True,  ..., False, False, False],
               [False, False,  True,  ..., False, False, False]],
 
              [[False, False, False,  ..., False, False, False],
               [False, False, False,  ..., False, False, False],
               [False, False, False,  ..., False, False, False],
               ...,
               [False, False, False,  ..., False, False, False],
               [False, False, False,  ..., False, False, False],
               [False, False, False,  ..., False, False, False]]],
             device='cuda:0'))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>b.shape,hash_loc.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>(torch.Size([64, 3, 320, 320]), torch.Size([64, 10, 10]))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="76">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>timeit b.view(<span class="dv">64</span>, <span class="dv">3</span>, <span class="dv">10</span>,<span class="dv">320</span><span class="op">//</span><span class="dv">10</span>, <span class="dv">10</span>,<span class="dv">320</span><span class="op">//</span><span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>15.4 µs ± 2.08 µs per loop (mean ± std. dev. of 7 runs, 10,000 loops each)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="81">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>tiled_img<span class="op">=</span>b.view(<span class="dv">64</span>, <span class="dv">3</span>, <span class="dv">10</span>,<span class="dv">320</span><span class="op">//</span><span class="dv">10</span>, <span class="dv">10</span>,<span class="dv">320</span><span class="op">//</span><span class="dv">10</span>).permute(<span class="dv">0</span>,<span class="dv">2</span>,<span class="dv">4</span>,<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">5</span>)</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>b.shape,tiled_img.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="81">
<pre><code>(torch.Size([64, 3, 320, 320]), torch.Size([64, 10, 10, 3, 32, 32]))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="80">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>show_images(b.view(<span class="dv">64</span>, <span class="dv">10</span>, <span class="dv">10</span>, <span class="dv">3</span>, <span class="dv">32</span>, <span class="dv">32</span>)[<span class="dv">0</span>].flatten(end_dim<span class="op">=</span><span class="dv">1</span>),nrows<span class="op">=</span><span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="LSH%20with%20random%20projection_files/figure-html/cell-43-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="82">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>b.view(<span class="dv">64</span>, <span class="dv">3</span>, <span class="dv">10</span>,<span class="dv">320</span><span class="op">//</span><span class="dv">10</span>, <span class="dv">10</span>,<span class="dv">320</span><span class="op">//</span><span class="dv">10</span>).shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="82">
<pre><code>torch.Size([64, 3, 10, 32, 10, 32])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="83">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>show_images(tiled_img[<span class="dv">0</span>].flatten(end_dim<span class="op">=</span><span class="dv">1</span>),nrows<span class="op">=</span><span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="LSH%20with%20random%20projection_files/figure-html/cell-45-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="94">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>tiled_img[<span class="dv">1</span>].shape,(hash_loc<span class="op">==</span><span class="dv">99</span>)[<span class="dv">0</span>].shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="94">
<pre><code>(torch.Size([10, 10, 3, 32, 32]), torch.Size([10, 10]))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="97">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>tiled_img[<span class="dv">8</span>][(hash_loc<span class="op">==</span><span class="dv">99</span>)[<span class="dv">8</span>]].shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="97">
<pre><code>torch.Size([15, 3, 32, 32])</code></pre>
</div>
</div>
</section>
<section id="how-would-select-select-the-patches-of-the-image-that-fall-into-our-mode-bucket" class="level6">
<h6 class="anchored" data-anchor-id="how-would-select-select-the-patches-of-the-image-that-fall-into-our-mode-bucket">How would select select the patches of the image that fall into our mode bucket?</h6>
<div class="cell" data-execution_count="104">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>tiled_img[<span class="dv">1</span>][hash_loc[<span class="dv">1</span>]<span class="op">==</span><span class="dv">199</span>].shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="104">
<pre><code>torch.Size([11, 3, 32, 32])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="54">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>show_image(b[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="54">
<pre><code>&lt;AxesSubplot:&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="LSH%20with%20random%20projection_files/figure-html/cell-49-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>Seems to detect “objects.” Other images included scales for weight things, and sea shells. Dog nose, might be due to that space being close.</p>
<div class="cell" data-scrolled="true" data-execution_count="55">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>show_images(tiled_img[<span class="dv">0</span>][hash_loc[<span class="dv">0</span>]<span class="op">==</span><span class="dv">199</span>][:<span class="dv">64</span>],nrows<span class="op">=</span><span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="LSH%20with%20random%20projection_files/figure-html/cell-50-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="98">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>show_images(tiled_img[<span class="dv">8</span>][(hash_loc<span class="op">==</span><span class="dv">99</span>)[<span class="dv">8</span>]],nrows<span class="op">=</span><span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="LSH%20with%20random%20projection_files/figure-html/cell-51-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="101">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>show_image(b[<span class="dv">8</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="101">
<pre><code>&lt;AxesSubplot:&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="LSH%20with%20random%20projection_files/figure-html/cell-52-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="103">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(dls.dataset)<span class="op">*</span><span class="dv">10</span><span class="op">*</span><span class="dv">10</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="103">
<pre><code>1295200</code></pre>
</div>
</div>
<div class="cell" data-execution_count="104">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="dv">1295200</span><span class="op">/</span><span class="dv">256</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="104">
<pre><code>5059.375</code></pre>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>